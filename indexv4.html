<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floor Transition Details v3.1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 1200px; margin: 0 auto; overflow: hidden; }
        .header { background: linear-gradient(135deg, #2F5496 0%, #1a3a6b 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 28px; margin-bottom: 5px; font-weight: 600; display: inline-block; }
        .version-tag { font-size: 12px; vertical-align: super; opacity: 0.7; margin-left: 8px; font-weight: 400; }
        .header p { font-size: 14px; opacity: 0.9; }
        .live-indicator { position: absolute; top: 15px; right: 15px; background: rgba(76,175,80,0.2); color: #4CAF50; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        
        .tabs { display: flex; background: #f5f5f5; border-bottom: 2px solid #e0e0e0; }
        .tab { flex: 1; padding: 15px 20px; text-align: center; cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab:hover { background: #ececec; color: #333; }
        .tab.active { background: white; color: #2F5496; border-bottom: 3px solid #2F5496; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .loading { padding: 40px; text-align: center; color: #666; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .content-wrapper { display: flex; gap: 20px; padding: 30px; }
        .selection-panel { flex: 1; min-width: 0; }
        .preview-panel { width: 400px; flex-shrink: 0; background: #f8f9fa; border-radius: 12px; padding: 20px; display: none; }
        .preview-panel.show { display: block; }
        .preview-panel h3 { font-size: 14px; color: #2F5496; margin-bottom: 15px; font-weight: 600; text-transform: uppercase; }
        .preview-image-container { width: 100%; height: 400px; background: #e0e0e0; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 15px; cursor: pointer; }
        .preview-image-container img { width: 100%; height: 100%; object-fit: cover; }
        .preview-info { text-align: center; padding: 15px; background: white; border-radius: 8px; }
        .preview-grid { font-size: 32px; font-weight: 700; color: #2F5496; margin-bottom: 8px; }
        .preview-materials { font-size: 14px; color: #666; }
        
        .instruction-box { background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px 20px; margin-bottom: 25px; border-radius: 4px; }
        .instruction-box h3 { font-size: 14px; color: #2F5496; margin-bottom: 8px; font-weight: 600; }
        .instruction-box p { font-size: 13px; color: #666; line-height: 1.6; }
        
        .input-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        select { width: 100%; padding: 12px 16px; font-size: 15px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer; transition: all 0.3s; }
        select:hover { border-color: #667eea; }
        select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        select:disabled { background: #f5f5f5; cursor: not-allowed; }
        
        .checkbox-container { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; }
        .checkbox-item { display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .checkbox-item:hover { background: #e8f0fe; }
        .checkbox-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 12px; cursor: pointer; }
        .checkbox-item label { margin: 0; cursor: pointer; font-size: 15px; text-transform: none; letter-spacing: normal; font-weight: 500; }
        
        .results-section { margin-top: 25px; padding: 25px; background: linear-gradient(135deg, #70AD47 0%, #5a8c38 100%); border-radius: 15px; color: white; display: none; }
        .results-section.show { display: block; animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .results-section h2 { font-size: 16px; margin-bottom: 15px; text-align: center; font-weight: 600; text-transform: uppercase; }
        .result-item { background: rgba(255,255,255,0.15); padding: 10px 15px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .result-label { font-weight: 600; font-size: 12px; text-transform: uppercase; }
        .result-value { font-size: 16px; font-weight: 700; text-align: right; }
        .result-value.grid-location { font-size: 28px; letter-spacing: 2px; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; background: rgba(255,255,255,0.3); }
        .not-assigned { background: rgba(255,193,7,0.2); color: #ffc107; padding: 15px; border-radius: 8px; text-align: center; font-weight: 600; }
        
        .gallery-container { padding: 30px; }
        .gallery-filters { display: flex; gap: 15px; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px; align-items: center; }
        .gallery-filters select { flex: 1; }
        .clear-filters-btn { padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .clear-filters-btn:hover { background: #c82333; transform: translateY(-1px); }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .gallery-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s; }
        .gallery-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .gallery-card-image { width: 100%; height: 200px; background: #e0e0e0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .gallery-card-image img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-card-image .no-image { color: #999; font-size: 14px; }
        .gallery-card-info { padding: 15px; text-align: center; }
        .gallery-card-grid { font-size: 36px; font-weight: 900; color: #2F5496; margin-bottom: 10px; letter-spacing: 1px; }
        .gallery-card-materials { font-size: 14px; color: #333; line-height: 1.4; font-weight: 600; margin-bottom: 10px; }
        .gallery-card-status { display: inline-block; padding: 4px 10px; background: #70AD47; color: white; border-radius: 12px; font-size: 11px; font-weight: 600; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); }
        .modal.show { display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: white; border-radius: 12px; max-width: 900px; max-height: 90vh; overflow-y: auto; position: relative; animation: slideUp 0.3s; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        .modal-close { position: absolute; top: 15px; right: 15px; width: 40px; height: 40px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .modal-close:hover { background: rgba(0,0,0,0.8); transform: rotate(90deg); }
        .modal-image { width: 100%; display: block; }
        .modal-details { padding: 30px; }
        .modal-grid { font-size: 48px; font-weight: 700; color: #2F5496; margin-bottom: 15px; }
        .modal-info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .modal-info-item { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .modal-info-label { font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }
        .modal-info-value { font-size: 16px; color: #333; font-weight: 600; }
        
        .footer { padding: 20px 30px; background: #f8f9fa; text-align: center; font-size: 12px; color: #666; }
        .last-updated { margin-top: 5px; font-size: 11px; color: #999; }
        .feedback-btn { display: inline-block; margin-top: 15px; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-size: 13px; font-weight: 600; transition: transform 0.2s; }
        .feedback-btn:hover { transform: translateY(-2px); }
        .feedback-btn::before { content: '✉ '; margin-right: 5px; }
        
        @media (max-width: 900px) {
            .content-wrapper { flex-direction: column; }
            .preview-panel { width: 100%; }
            .gallery-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
            .modal-content { margin: 20px; max-width: calc(100% - 40px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="live-indicator">Live Data</div>
            <h1>Floor Transition Details<span class="version-tag">v3.1</span></h1>
            <p>Detail Grid Location Lookup System</p>
        </div>

        <div id="loadingSection" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading data from Google Sheets...</p>
        </div>

        <div id="mainContent" style="display:none;">
            <div class="tabs">
                <div class="tab active" data-tab="dropdown">Dropdown Mode</div>
                <div class="tab" data-tab="checkbox">Checkbox Mode</div>
                <div class="tab" data-tab="gallery">Gallery View</div>
            </div>

            <div class="tab-content active" id="dropdown-content">
                <div class="content-wrapper">
                    <div class="selection-panel">
                        <div class="instruction-box">
                            <h3>How to Use</h3>
                            <p>Select two floor materials from the dropdowns below. The preview will show on the right if available.</p>
                        </div>
                        <div class="input-group">
                            <label for="dropdown-mat1">Material 1</label>
                            <select id="dropdown-mat1"></select>
                        </div>
                        <div class="input-group">
                            <label for="dropdown-mat2">Material 2</label>
                            <select id="dropdown-mat2"></select>
                        </div>
                        <div class="results-section" id="dropdown-results"></div>
                    </div>
                    <div class="preview-panel" id="dropdown-preview">
                        <h3>Preview</h3>
                        <div class="preview-image-container" id="dropdown-preview-image">
                            <span style="color:#999;">Select materials to preview</span>
                        </div>
                        <div class="preview-info" id="dropdown-preview-info"></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="checkbox-content">
                <div class="content-wrapper">
                    <div class="selection-panel">
                        <div class="instruction-box">
                            <h3>How to Use</h3>
                            <p>Check a material from the first list, then check a paired material from the filtered second list.</p>
                        </div>
                        <label>Select Material 1:</label>
                        <div class="checkbox-container" id="checkbox-mat1-container"></div>
                        <label>Select Material 2:</label>
                        <div class="checkbox-container" id="checkbox-mat2-container">
                            <p style="color:#999;text-align:center;">Select Material 1 first</p>
                        </div>
                        <div class="results-section" id="checkbox-results"></div>
                    </div>
                    <div class="preview-panel" id="checkbox-preview">
                        <h3>Preview</h3>
                        <div class="preview-image-container" id="checkbox-preview-image">
                            <span style="color:#999;">Select materials to preview</span>
                        </div>
                        <div class="preview-info" id="checkbox-preview-info"></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="gallery-content">
                <div class="gallery-container">
                    <div class="gallery-filters">
                        <select id="gallery-filter-mat1">
                            <option value="">All Materials (Filter 1)</option>
                        </select>
                        <select id="gallery-filter-mat2">
                            <option value="">All Materials (Filter 2)</option>
                        </select>
                        <button class="clear-filters-btn" onclick="clearGalleryFilters()">Clear Filters</button>
                    </div>
                    <div class="gallery-grid" id="gallery-grid"></div>
                </div>
            </div>

            <div class="footer">
                Floor Transition Details &copy; 2024 | Barker/Nestor Inc.
                <div class="last-updated" id="lastUpdated"></div>
                <a href="mailto:ddavid@barkernestor.com?subject=Material Finder Feedback" class="feedback-btn">Send Feedback</a>
            </div>
        </div>
    </div>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <img class="modal-image" id="modal-image" src="" alt="">
            <div class="modal-details">
                <div class="modal-grid" id="modal-grid"></div>
                <div class="modal-info-grid" id="modal-info"></div>
            </div>
        </div>
    </div>

    <script>
        console.log('=== APP STARTING ===');
        
        const SHEET_ID = '1v3zNXysqwsWYd15BCsYjSCG3vD6RzoERe7NWARgCIsE';
        let materials = [];
        let pairs = [];

        function loadSheet(name, callback) {
            return new Promise((resolve, reject) => {
                const cb = 'cb_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
                
                // Added Cache Buster (&t=) to force browser to ignore cache
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json;responseHandler:${cb}&sheet=${name}&t=${Date.now()}`;
                
                window[cb] = function(data) {
                    console.log('✓ Loaded:', name);
                    callback(data);
                    delete window[cb];
                    const scriptTag = document.getElementById('sheet-script-' + cb);
                    if (scriptTag) document.body.removeChild(scriptTag);
                    resolve();
                };
                
                const s = document.createElement('script');
                s.id = 'sheet-script-' + cb;
                s.src = url;
                s.onerror = () => reject('Failed: ' + name);
                document.body.appendChild(s);
            });
        }

        function parseMaterials(data) {
            materials = [];
            data.table.rows.forEach(row => {
                if (!row.c) return;
                const id = row.c[0]?.v;
                const name = row.c[1]?.v;
                const active = row.c[2]?.v;
                if (id && name && active?.toString().toLowerCase() === 'yes') {
                    materials.push({id, name});
                }
            });
            materials.sort((a,b) => a.name.localeCompare(b.name));
        }

        function parsePairs(data) {
            pairs = [];
            data.table.rows.forEach((row, i) => {
                if (i === 0 || !row.c) return;
                const a_id = row.c[0]?.v;
                const a_name = row.c[1]?.v;
                const b_id = row.c[2]?.v;
                const b_name = row.c[3]?.v;
                const key = row.c[4]?.v;
                const grid = row.c[5]?.v;
                const status = row.c[6]?.v || 'Draft';
                const notes = row.c[7]?.v || '';
                const img = (row.c[8] && row.c[8].v) ? row.c[8].v.toString().trim() : '';
                
                if (a_id && b_id && key) {
                    pairs.push({a_id, a_name, b_id, b_name, key, grid: grid || 'Not Assigned', status, notes, img});
                }
            });
            console.log('Pairs Updated:', pairs.length);
        }

        function getImageUrl(pair) {
            if (pair.img && pair.img !== '') {
                let fileId = pair.img;
                // Extraction logic in case full links are used
                if (fileId.includes('id=')) {
                    fileId = fileId.split('id=')[1].split('&')[0];
                } else if (fileId.includes('/d/')) {
                    fileId = fileId.split('/d/')[1].split('/')[0];
                }
                // High-quality preview thumbnail endpoint
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
            }
            return null;
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tabName + '-content').classList.add('active');
            });
        });

        function initDropdown() {
            const mat1 = document.getElementById('dropdown-mat1');
            const mat2 = document.getElementById('dropdown-mat2');
            mat1.innerHTML = '<option value="">-- Select Material 1 --</option>';
            mat2.innerHTML = '<option value="">-- Select Material 2 --</option>';
            materials.forEach(m => {
                mat1.add(new Option(m.name, m.id));
                mat2.add(new Option(m.name, m.id));
            });
            mat1.onchange = () => { filterDropdownMat2(); updateDropdown(); };
            mat2.onchange = updateDropdown;
        }

        function filterDropdownMat2() {
            const id1 = document.getElementById('dropdown-mat1').value;
            const mat2 = document.getElementById('dropdown-mat2');
            const curr = mat2.value;
            mat2.innerHTML = '<option value="">-- Select Material 2 --</option>';
            if (!id1) {
                materials.forEach(m => mat2.add(new Option(m.name, m.id)));
            } else {
                const paired = new Set();
                pairs.forEach(p => {
                    if (p.a_id === id1) paired.add(p.b_id);
                    if (p.b_id === id1) paired.add(p.a_id);
                });
                materials.forEach(m => {
                    if (paired.has(m.id)) mat2.add(new Option(m.name, m.id));
                });
            }
            if (curr && Array.from(mat2.options).some(o => o.value === curr)) mat2.value = curr;
        }

        function updateDropdown() {
            const id1 = document.getElementById('dropdown-mat1').value;
            const id2 = document.getElementById('dropdown-mat2').value;
            if (!id1 || !id2) {
                document.getElementById('dropdown-results').classList.remove('show');
                document.getElementById('dropdown-preview').classList.remove('show');
                return;
            }
            const key = [id1, id2].sort().join('–');
            const pair = pairs.find(p => p.key === key);
            if (pair && pair.grid !== 'Not Assigned') {
                showResults('dropdown-results', pair);
                showPreview('dropdown-preview', 'dropdown-preview-image', 'dropdown-preview-info', pair);
            } else {
                document.getElementById('dropdown-results').innerHTML = '<div class="not-assigned">⚠ This pairing has not been assigned yet.</div>';
                document.getElementById('dropdown-results').classList.add('show');
                document.getElementById('dropdown-preview').classList.remove('show');
            }
        }

        function initCheckbox() {
            const container1 = document.getElementById('checkbox-mat1-container');
            container1.innerHTML = '';
            materials.forEach(m => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                item.innerHTML = `<input type="checkbox" id="cb1-${m.id}" value="${m.id}" name="cb-mat1"><label for="cb1-${m.id}">${m.name}</label>`;
                item.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = item.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                    handleCheckboxMat1();
                };
                container1.appendChild(item);
            });
        }

        function handleCheckboxMat1() {
            const cbs = document.querySelectorAll('input[name="cb-mat1"]');
            let selected = null;
            cbs.forEach(cb => {
                if (cb.checked && !selected) selected = cb.value;
                else cb.checked = false;
            });
            const container2 = document.getElementById('checkbox-mat2-container');
            container2.innerHTML = '';
            document.querySelectorAll('input[name="cb-mat2"]').forEach(cb => cb.checked = false);
            if (!selected) {
                container2.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">Select Material 1 first</p>';
                document.getElementById('checkbox-results').classList.remove('show');
                document.getElementById('checkbox-preview').classList.remove('show');
                return;
            }
            const paired = new Set();
            pairs.forEach(p => {
                if (p.a_id === selected) paired.add(p.b_id);
                if (p.b_id === selected) paired.add(p.a_id);
            });
            materials.forEach(m => {
                if (paired.has(m.id)) {
                    const item = document.createElement('div');
                    item.className = 'checkbox-item';
                    item.innerHTML = `<input type="checkbox" id="cb2-${m.id}" value="${m.id}" name="cb-mat2"><label for="cb2-${m.id}">${m.name}</label>`;
                    item.onclick = (e) => {
                        if (e.target.tagName !== 'INPUT') {
                            const cb = item.querySelector('input');
                            cb.checked = !cb.checked;
                        }
                        handleCheckboxMat2();
                    };
                    container2.appendChild(item);
                }
            });
        }

        function handleCheckboxMat2() {
            const cbs = document.querySelectorAll('input[name="cb-mat2"]');
            let selected = null;
            cbs.forEach(cb => {
                if (cb.checked && !selected) selected = cb.value;
                else cb.checked = false;
            });
            if (!selected) {
                document.getElementById('checkbox-results').classList.remove('show');
                document.getElementById('checkbox-preview').classList.remove('show');
                return;
            }
            const id1 = document.querySelector('input[name="cb-mat1"]:checked')?.value;
            if (!id1) return;
            const key = [id1, selected].sort().join('–');
            const pair = pairs.find(p => p.key === key);
            if (pair && pair.grid !== 'Not Assigned') {
                showResults('checkbox-results', pair);
                showPreview('checkbox-preview', 'checkbox-preview-image', 'checkbox-preview-info', pair);
            }
        }

        function initGallery() {
            const f1 = document.getElementById('gallery-filter-mat1');
            const f2 = document.getElementById('gallery-filter-mat2');
            materials.forEach(m => {
                f1.add(new Option(m.name, m.id));
                f2.add(new Option(m.name, m.id));
            });
            f1.onchange = filterGallery;
            f2.onchange = filterGallery;
            renderGallery();
        }

        function filterGallery() {
            const id1 = document.getElementById('gallery-filter-mat1').value;
            const id2 = document.getElementById('gallery-filter-mat2').value;
            let filtered = pairs;
            if (id1 && id2) {
                const key = [id1, id2].sort().join('–');
                filtered = filtered.filter(p => p.key === key);
            } else if (id1) {
                filtered = filtered.filter(p => p.a_id === id1 || p.b_id === id1);
            } else if (id2) {
                filtered = filtered.filter(p => p.a_id === id2 || p.b_id === id2);
            }
            renderGallery(filtered);
        }

        function clearGalleryFilters() {
            document.getElementById('gallery-filter-mat1').value = '';
            document.getElementById('gallery-filter-mat2').value = '';
            renderGallery();
        }

        function renderGallery(pairsToShow = pairs) {
            const grid = document.getElementById('gallery-grid');
            grid.innerHTML = '';
            pairsToShow.forEach(p => {
                if (p.grid === 'Not Assigned') return;
                const card = document.createElement('div');
                card.className = 'gallery-card';
                card.onclick = () => openModal(p);
                const imgUrl = getImageUrl(p);
                const imgHtml = imgUrl 
                    ? `<img src="${imgUrl}" alt="${p.grid}" onerror="this.parentElement.innerHTML='<span class=\\'no-image\\'>No image</span>'">`
                    : '<span class="no-image">No image</span>';
                card.innerHTML = `
                    <div class="gallery-card-image">${imgHtml}</div>
                    <div class="gallery-card-info">
                        <div class="gallery-card-grid">${p.grid}</div>
                        <div class="gallery-card-materials">${p.a_name} + ${p.b_name}</div>
                        <div class="gallery-card-status">${p.status}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function showResults(containerId, pair) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <h2>Results</h2>
                <div class="result-item">
                    <span class="result-label">Grid Location</span>
                    <span class="result-value grid-location">${pair.grid}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Pair Key</span>
                    <span class="result-value">${pair.key}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Status</span>
                    <span class="result-value"><span class="status-badge">${pair.status}</span></span>
                </div>
                ${pair.notes && pair.notes.trim() ? `
                <div class="result-item" style="flex-direction:column;align-items:flex-start;">
                    <span class="result-label" style="margin-bottom:8px;">Notes</span>
                    <span class="result-value" style="font-size:13px;line-height:1.4;text-align:left;font-weight:400;">${pair.notes}</span>
                </div>
                ` : ''}
            `;
            container.classList.add('show');
        }

        function showPreview(panelId, imageId, infoId, pair) {
            const panel = document.getElementById(panelId);
            const imageContainer = document.getElementById(imageId);
            const info = document.getElementById(infoId);
            const imgUrl = getImageUrl(pair);
            if (imgUrl) {
                const safePair = JSON.stringify(pair).replace(/'/g, "\\'");
                imageContainer.innerHTML = `<img src="${imgUrl}" alt="${pair.grid}" onclick='openModal(${safePair})' onerror="this.parentElement.innerHTML='<span style=\\'color:#999\\'>Image not available</span>'">`;
                info.innerHTML = `<div class="preview-grid">${pair.grid}</div><div class="preview-materials">${pair.a_name} + ${pair.b_name}</div>`;
                panel.classList.add('show');
            } else {
                panel.classList.remove('show');
            }
        }

        function openModal(pair) {
            const modal = document.getElementById('detailModal');
            const img = document.getElementById('modal-image');
            const grid = document.getElementById('modal-grid');
            const info = document.getElementById('modal-info');
            const imgUrl = getImageUrl(pair);
            img.src = imgUrl || '';
            img.style.display = imgUrl ? 'block' : 'none';
            grid.textContent = pair.grid;
            info.innerHTML = `
                <div class="modal-info-item"><div class="modal-info-label">Material 1</div><div class="modal-info-value">${pair.a_name}</div></div>
                <div class="modal-info-item"><div class="modal-info-label">Material 2</div><div class="modal-info-value">${pair.b_name}</div></div>
                <div class="modal-info-item"><div class="modal-info-label">Pair Key</div><div class="modal-info-value">${pair.key}</div></div>
                <div class="modal-info-item"><div class="modal-info-label">Status</div><div class="modal-info-value">${pair.status}</div></div>
                ${pair.notes && pair.notes.trim() ? `
                <div class="modal-info-item" style="grid-column:1/-1;"><div class="modal-info-label">Notes</div><div class="modal-info-value" style="font-weight:400;">${pair.notes}</div></div>
                ` : ''}
            `;
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        document.getElementById('detailModal').onclick = (e) => {
            if (e.target.id === 'detailModal') closeModal();
        };

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = 'Last synced: ' + now.toLocaleString('en-US', {month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit',second:'2-digit',hour12:true});
        }

        Promise.all([
            loadSheet('Floor_Materials', parseMaterials),
            loadSheet('Material_Pairs', parsePairs)
        ])
        .then(() => {
            console.log('=== DATA LOADED ===');
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            initDropdown();
            initCheckbox();
            initGallery();
            updateTimestamp();
            console.log('=== APP READY ===');
        })
        .catch(err => {
            console.error('ERROR:', err);
            document.getElementById('loadingSection').innerHTML = '<div style="color:red;padding:40px;">Error loading data: ' + err + '</div>';
        });
    </script>
</body>
</html>
